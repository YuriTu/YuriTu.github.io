<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />




  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico?v=5.1.4">






  <meta name="keywords" content="blog,tuqiang,webgl" />










<meta property="og:type" content="website">
<meta property="og:title" content="住何乡">
<meta property="og:url" content="http://tuqiang.website/index.html">
<meta property="og:site_name" content="住何乡">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="住何乡">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://tuqiang.website/"/>





  <title>住何乡</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2577307c02362ff403e4ea6931bf024b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">住何乡</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tuqiang.website/2018/01/14/用three.js打造粒子动画/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yuri">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="住何乡">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/14/用three.js打造粒子动画/" itemprop="url">用three.js打造粒子动画</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-14T00:00:00+08:00">
                2018-01-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="用three-js打造粒子动画"><a href="#用three-js打造粒子动画" class="headerlink" title="用three.js打造粒子动画"></a>用three.js打造粒子动画</h1><p>最近为了给以后的运营需求做技术积累，对3D动画在组内的落地进行了一些研究。切入点是粒子动画，这是最容易实现的3D动画。</p>
<p>最后做出了一些还可以的效果。把其中的经验与坑记录一下<br>由于只在内网上线，所以暂时用gif来表示（gif掉帧比较大，真实还是非常流畅的）。<br><img src="http://odf9m3avc.bkt.clouddn.com/hi.gif" alt="hi"></p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p>这里不再赘述 webGL底层与图形学，我们这里说three的基础</p>
<p>three.js构成一个物体的本质是三样<br>1.Geometry 几何 负责物体长什么样子<br>2.material 材料 负责物体对光线的交互<br>3.mesh 网格 geo与mat的承载者</p>
<p>粒子动画的粒子构成有三种思路</p>
<ol>
<li>Points + Vector3 </li>
</ol>
<p>最常用的一种，一个父级对象作为粒子系统，子为坐标点矢量</p>
<p>好处是方便建立，开一个随机数组，xyz三值赋值即可</p>
<p>缺点是不方便为控制每一个粒子，如果想对每个粒子的颜色大小等进行控制无法达到，因为Vector对象本质上是矢量，不包含这些东西，矢量擅长的事情是位移。</p>
<ol>
<li>Group + Mesh </li>
</ol>
<p>这种方式的优点是</p>
<p>可以操控所有的粒子属性，大而全，就像一个IDE，你能做的事情都帮你做了，建立起来也和Vector非常相似，十分容易。</p>
<p>缺点是非常耗费性能，2D动画的性能一般由计算和渲染决定，而由于GPU太擅长矩阵计算了，计算耗费相对于渲染微不足道。渲染性能耗费主要就在于GPU要计算多少面，而每一个Mesh对象又是独立的，如果采用MergeGeometry的方法则无法控制每一个粒子。</p>
<ol>
<li>BufferGeometry + ShaderMaterial</li>
</ol>
<p>使用缓冲区来降低性能消耗，还能完整控制每个属性。</p>
<p>就是难写…<br><img src="http://odf9m3avc.bkt.clouddn.com/%E5%90%83%E6%83%8A.jpg" alt=""></p>
<p><strong>BufferGeometry</strong>要求Float32Array，为3 <em> n矩阵来确定位置信息，颜色与大小等则同样为 1</em> n的矩阵。与上面两种直接给实例的方式不一样。<br>举个🌰<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> v = <span class="keyword">new</span> THREE.Vector3();</span><br><span class="line"><span class="keyword">const</span> length = n;</span><br><span class="line"><span class="keyword">let</span> rs = <span class="keyword">new</span> <span class="built_in">Array</span>(length * <span class="number">3</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">    v.x = x</span><br><span class="line">    v.y = y;</span><br><span class="line">    v.z = z;</span><br><span class="line">    v.toArray(rs, i * <span class="number">3</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> rs</span><br></pre></td></tr></table></figure></p>
<p>这里我们用一个Vector3.toArray来帮我们来完成矩阵排列，当然这样就是要你不要<br>用 index index + 1 index + 2 的方式来表示xyz，因为在真实开发环境中可能有复杂情况让你不是那么好算。</p>
<p>这里返回一个普通array 你可以直接用 new Float32Array()或者用原型链方法from来进行array 到 float。</p>
<p><strong>ShaderMaterial</strong>就更麻烦了,因为他涉及到我们需要自己写用GLSL语言来写着色器，它可以让你充分的发挥GPU的威力但是对于习惯了写JS的一些fe来说，突然去写类C的这样一种语言还是会有一些不适应的。</p>
<h2 id="开发难点处理"><a href="#开发难点处理" class="headerlink" title="开发难点处理"></a>开发难点处理</h2><ol>
<li>模型算法</li>
</ol>
<p>three.js帮你把底层基本上能做的事，都做了，封装的也非常好，虽说官方文档有点云里雾里的但是跟着看看源码也就明白了，作者的源码写的是真心话简单朴实不炫技。</p>
<p>那么对于我们开发者的难度就在于算法上了，算法有两个问题</p>
<p>1.1 物体建模</p>
<p>有UI支撑帮忙建模自然最好，但是从经验来看还是靠不住的；我们需要自己用算法实现物体的效果，比如说一个渐变缩小的金字塔，他的每个粒子之间的的关系方程式，需要我们花费时间去处理。这里面就涉及到调参的问题，如何快速的精确调整与展示结果，直接影响到我们的开发效率，这里three官方用的是 <a href="https://github.com/dataarts/dat.gui" target="_blank" rel="noopener">dat.gui</a>，能解决我们所需要的快速展示结果的需求，问题就是需要花费时间添加代码。理想来说应该可以集成在一个框架中，来减少开发成本，但是目前生态不算完善，可以考虑自己造轮子。</p>
<p>1.2 数据生成</p>
<p>随机数据的生成以及对数据状态的变化，也是一个需要解决的部分，建立好的模型，怎么去进行动画。位移、大小、颜色、形变等等，都需要一个规律的算法来实现，简单的补间动画我们可以使用<a href="https://github.com/tweenjs/tween.js" target="_blank" rel="noopener">TWEEN</a>来实现，但是真正那些好看的效果，还是需要我们通过各种三角函数、矩阵变换等来实现，这里暂时没有什么太好的处理方法，只能说是多看实例，积累算法。</p>
<ol>
<li>动画思路</li>
</ol>
<p>在动画各幕对象差很多的情况该怎么办？</p>
<p>在我的动画中，四幕粒子数约为 10k, .5k, 2k, 3k ，那么这里涉及到第一幕多出来的粒子怎么处理？让他飞出去在销毁？毕竟多这么多挺费内存的。但是我没有这么干，而是循环原样摆放，也就是说我的10k个粒子，在第二幕其实摆了20遍，只不过他们重合了，看起来像只有很少。</p>
<p>有两个原因：</p>
<ol>
<li>不缺这点性能</li>
</ol>
<p>GPU前向算法会将不出现的物体不进行渲染。10k粒子对GPU不算啥事。</p>
<ol>
<li>工程难度</li>
</ol>
<p>如果我反复操作粒子总量更加困难不说，也容易出bug延误工期，现在都敏捷开发，一天出80分的活，也不会让你一周干到100分，毕竟可以后续再迭代。</p>
<h2 id="工程化考量"><a href="#工程化考量" class="headerlink" title="工程化考量"></a>工程化考量</h2><p>本质上来说Three.js像是Jq，他的定位是一个库，3D的开发模式还是比较传统，没有React等这样的革新开发模型的框架出现，也不想2D有CreateJS这样的容错很高的框架存在，整个生态还是比较原始的一片处女地，在错误捕捉、性能提升、开发体验上暂时还都需要开发者自己来完成。</p>
<p>我自己把日常工作中沉淀了一下，做一个专为动画设计的工具库，<a href="https://github.com/YuriTu/Christina" target="_blank" rel="noopener">Christina.js</a>目前还很不完善， 只是集成了一些我觉得常用到的操作与算法，希望能对开发效率上有一定的提升。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总体上这次开发还是挺仓促的，一共10/人/天，性能上没有任何优化，在内存上也有很多浪费和需要处理的地方，这都需要在后续的开发中再优化，在提高开发效果和快速成果展示上也还需要继续优化。但总体上我还是满意的。</p>
<p>希望本文能给你一些灵感。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tuqiang.website/2017/10/17/Make React Great Again —— React v16 新特性/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yuri">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="住何乡">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/17/Make React Great Again —— React v16 新特性/" itemprop="url">Make React Great Again —— React v16 新特性</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-17T00:00:00+08:00">
                2017-10-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>tl;dr  对于开发者而言最大的影响是MIT协议的改变，其次是传送门对开发方式的优化以及ssr方面的巨大提升。</p>
<hr>
<p>React16 在国庆前发布了，这次版本迭代带来了许多令人激动的新特性。</p>
<h1 id="协议的改变"><a href="#协议的改变" class="headerlink" title="协议的改变"></a>协议的改变</h1><p>前不久的React在业界引起了不小的波澜，更有国外WordPress与国内大厂百度的封杀React，以至于不少开发者认为Vue或成最大赢家。<br>终于FB将React16改为MIT协议，对于不升级的开发者也有MIT协议的15.6.2的旧版本可以选择。不过之前此举多少伤害了开发者对其的信任，FB是否再会出尔反尔，也影响这技术负责人对技术栈的选取。</p>
<h1 id="传送门-（Portal）"><a href="#传送门-（Portal）" class="headerlink" title="传送门 （Portal）"></a>传送门 （Portal）</h1><p>长久以来全局的模态框、dialog、tooltips等等全局组件的DOM位置问题，终于有了优雅的解决方案。</p>
<p>当我们需要一个全局的提示框时，作为通用组件，它是脱离我们当前开发的业务组件的，因为从state的设计上，提示框的显隐是一个私有变量，而文案内容等一般由当前业务组件的props来决定，这就导致在业务组件中添加了一个无关组件，一来影响我们关注点分离的思想，二来难以复用。</p>
<p>另一方面由于DOM层级的影响css的规则与书写有会造成困难，你无法控制Module父元素的css状态，从而导致无法良好的抽象。</p>
<p>举个栗子：</p>
<p>理想的状态是这样</p>
<p>我们的模态框可以复用，等待数据流灌入即可。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> = jsx = (</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;Main/&gt;</span><br><span class="line">	&lt;Other/&gt;</span><br><span class="line">	&lt;Module/&gt;</span><br><span class="line">&lt;<span class="regexp">/body&gt;</span></span><br><span class="line"><span class="regexp">)</span></span><br></pre></td></tr></table></figure>
<p>可是实际上开发却是这样<br><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> jsx = (</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;Main&gt;</span><br><span class="line">		&lt;components/&gt;</span><br><span class="line">		&lt;Module/&gt;</span><br><span class="line">	&lt;<span class="regexp">/Main&gt;</span></span><br><span class="line"><span class="regexp">	&lt;Other&gt;</span></span><br><span class="line"><span class="regexp">		&lt;components/</span>&gt;</span><br><span class="line">		&lt;Module&gt;</span><br><span class="line">	&lt;<span class="regexp">/Other&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>body&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>当然是用Redux可以完成第一种的设计，可是单单为了一个提示框就如此大弄干戈真的有必要吗？</p>
<p>React16提供了一种 将组件内部一些DOM元素绑定在外部组件的DOM上的方法，简单来说就是 在组件内部render一个组件，却能把这个render 的结果挂载在别的DOM上。从而完成我们所说的组件结构的优化与复用。</p>
<p>而如果我们使用portals 开发时组件结构就可以不变<br><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> jsx = (</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;Main&gt;</span><br><span class="line">		&lt;components/&gt;</span><br><span class="line">		&lt;Module/ ...props&gt; <span class="comment">// 接受数据与事件冒泡</span></span><br><span class="line">	&lt;<span class="regexp">/Main&gt;</span></span><br><span class="line"><span class="regexp">	&lt;Other&gt;</span></span><br><span class="line"><span class="regexp">		&lt;components/</span>&gt;</span><br><span class="line">		&lt;Module ...props&gt; <span class="comment">// 接受数据与事件冒泡</span></span><br><span class="line">	&lt;<span class="regexp">/Other&gt;</span></span><br><span class="line"><span class="regexp">	&lt;Module&gt;/</span><span class="regexp">/ 真实渲染 选择挂载位置为根元素</span></span><br><span class="line"><span class="regexp">&lt;/</span>body&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>我们在业务组件中，控制公共组件的state数据，进而指定公共组件的渲染位置，最后达到良好的复用。</p>
<p>从代码上来说，我们的业务组件可以这么写<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//以前我们渲染会这么写</span></span><br><span class="line">render() &#123;</span><br><span class="line">	reutrn (</span><br><span class="line">		&lt;div&gt;&#123;<span class="keyword">this</span>.props.children&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">	)</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/如果我们需要制定Module的挂载位置</span></span><br><span class="line"><span class="regexp">render () &#123;</span></span><br><span class="line"><span class="regexp">	return ReactDOM.createPortal(</span></span><br><span class="line"><span class="regexp">		&lt;Module ...props.module&gt;,/</span><span class="regexp">/这里是我们要给传送门的东西</span></span><br><span class="line"><span class="regexp">		this.props.node/</span><span class="regexp">/需要挂载的地方</span></span><br><span class="line"><span class="regexp">	)</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>而且传送门能够实现事件的冒泡，你不用担心开发时的父组件无法监听相关的事件，它的表现会像一个正常的组件一样，无论你把全局组件挂载到哪里。</p>
<h1 id="异步渲染-（async-rendering）"><a href="#异步渲染-（async-rendering）" class="headerlink" title="异步渲染 （async rendering）"></a>异步渲染 （async rendering）</h1><p>这东西厉害了，这是react提出的一个很先进的概念，由于React16使用了新的Fiber架构来进行项目构建(这个Fiber架构具体是什么，<a href="https://code.facebook.com/posts/1716776591680069/react-16-a-look-inside-an-api-compatible-rewrite-of-our-frontend-ui-library/" target="_blank" rel="noopener">博客</a>里说的很难我没看懂)，从而开发了异步渲染。</p>
<p>异步渲染是一种 与浏览器进行协作 以 定期执行对渲染任务的排序的策略（这块不太好理解 原文是 a strategy for cooperatively scheduling rendering work by periodically yielding execution to the browser. ）</p>
<p>通过异步渲染，以及避免react占用主线程，从而让页面动画更加流畅，可以看一下这个例子 <a href="https://build-mbfootjxoo.now.sh/" target="_blank" rel="noopener">demo</a></p>
<p>主要注意右上角那个黑方块，他一直在旋转占用着主线程，然后我们去进行请求，请求后会渲染页面，导致进程占用，页面重新渲染，方块旋转停止。</p>
<p>如果我们采用异步渲染就可以完成 在不占用主进程的情况进行渲染操作，从而不影响其他的元素。</p>
<p>这个功能并没有在React16实装，但是在博客中提到了未来几个月后可能会推出。</p>
<h1 id="碎片DOM-（fragments）"><a href="#碎片DOM-（fragments）" class="headerlink" title="碎片DOM （fragments）"></a>碎片DOM （fragments）</h1><p>你再也不用给jsx带套了，<code>render</code>函数接受更加多样的数据结构。<br>一般我们写一个列表可能是这样</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> renderChildren = <span class="function">(<span class="params">arr</span>) =&gt;</span> (</span><br><span class="line">	&lt;ul&gt;</span><br><span class="line">		&#123;arr.map( <span class="function"><span class="params">i</span> =&gt;</span> (&lt;li&gt;&#123;i&#125;&lt;/li&gt;)  )&#125;</span><br><span class="line">	&lt;<span class="regexp">/ul&gt;</span></span><br><span class="line"><span class="regexp">)</span></span><br></pre></td></tr></table></figure>
<p>我们干什么都要给加个父元素的contianer，这样一方面结构不明朗，另一面有可能会有多余的元素，而现在我们可以直接输出数组或者字符串了。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">render() &#123;</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    &lt;li key=<span class="string">"A"</span>&gt;First item&lt;<span class="regexp">/li&gt;,</span></span><br><span class="line"><span class="regexp">    &lt;li key="B"&gt;Second item&lt;/</span>li&gt;,</span><br><span class="line">    &lt;li key=<span class="string">"C"</span>&gt;Third item&lt;<span class="regexp">/li&gt;,</span></span><br><span class="line"><span class="regexp">  ];</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ or</span></span><br><span class="line"><span class="regexp">render() &#123;</span></span><br><span class="line"><span class="regexp">  return 'Look ma, no spans!';</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="文件体积优化"><a href="#文件体积优化" class="headerlink" title="文件体积优化"></a>文件体积优化</h1><p>相对于上个版本有30%的减少</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>新版本（kb）</th>
<th>压缩后（kb）</th>
<th>旧版本（kb）</th>
<th>压缩后 （kb）</th>
</tr>
</thead>
<tbody>
<tr>
<td>react</td>
<td>5.3</td>
<td>2.2</td>
<td>20.7</td>
<td>6.9</td>
</tr>
<tr>
<td>react-dom</td>
<td>103.7</td>
<td>32.6</td>
<td>141</td>
<td>42.9</td>
</tr>
<tr>
<td>react+react-dom</td>
<td>109</td>
<td>34.8</td>
<td>161.7</td>
<td>49.8</td>
</tr>
</tbody>
</table>
<p>React文档上说由于对打包方式的改变，React 采用 Rollup打包，所产生的bundle不会受到工具的影响，比如webpack、Browserify、UMD或者其他的工具。这个Rollup是一个模块打包器，它能把小的代码打进比较大的或者更加复杂的库，是一个比较新的库。</p>
<p>另一个方面是 react自持自定义DOM属性了，由于不用再设置属性的白名单，一定程度上减少了文件大小。这个特性主要是为ssr服务的。</p>
<h1 id="提升服务端渲染性能"><a href="#提升服务端渲染性能" class="headerlink" title="提升服务端渲染性能"></a>提升服务端渲染性能</h1><p>这是新版本重点更新的特性之一，笔者SSR经验比较少，体会不是很深，感觉React16比较明显的提升是性能上的。</p>
<p>React16对ssr主要是性能提升了3倍以上，如果是最新版本node实验环境下提升更是达到了数量级的提升。</p>
<p>还有一个比较大的区别是在html到达客户端之后，react并不会去比较初次的渲染结果与服务端结果，react会尽量去重用相同的DOM元素，这也是为了优化ssr中的“注水”过程，从而提升ssr的性能。因为一般情况下我们的服务端与客户端也不会渲染不同的内容，除非是做时间戳的一些东西。</p>
<p>笔者认为对开发者影响比较大的特性就是以上这些了，总体来说新的特性能够解决一些日常开发的痛点，开发体验也越来越好了，不过React16因为用了ES6的一些集合数据结构例如<code>Map</code> 和<code>Set</code>所以，兼容性要求比较高，如果需要兼容老式浏览器需要上polyfill比如<code>core.js</code>和 <code>babel-polyfill</code>。</p>
<p>还有一些特性比如 错误捕捉的优化、api更新与打包的改变有兴趣的同学可以关注一下<a href="https://reactjs.org/blog/2017/09/26/react-v16.0.html" target="_blank" rel="noopener">React的博客</a>来了解。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tuqiang.website/2017/07/21/webpack 3.0 上车指北/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yuri">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="住何乡">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/21/webpack 3.0 上车指北/" itemprop="url">webpack 3.0 上车指北</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-21T00:00:00+08:00">
                2017-07-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>想要解决的问题：<br>项目是否要 换 3.0<br>如何从webpack1.x 向 3.0过渡<br>相关兼容问题</p>
<blockquote>
<p><strong>TL；DR</strong><br>对打包体积优化差强人意，但是速度优化让人惊喜<br>有一些API的改变，总体上可以无痛升级</p>
</blockquote>
<hr>
<p>webpack3前段时间推出了，我对新版本进行了一些探索。</p>
<h1 id="需不需要升级"><a href="#需不需要升级" class="headerlink" title="需不需要升级"></a>需不需要升级</h1><p>判断标准就是：想解决的问题webpack能帮你以<strong>低成本</strong>解决吗</p>
<p>我想解决的问题是：</p>
<ol>
<li>打包时间太长，每次fixbug进行项目打包需要5分多钟</li>
<li>体积太大，简单页面100k+ ，复杂页面500k-700k+，</li>
</ol>
<h2 id="技术选型标准"><a href="#技术选型标准" class="headerlink" title="技术选型标准"></a>技术选型标准</h2><p>关于技术选型我觉得不同项目需要不同对待，我的理解是</p>
<blockquote>
<p>个人项目怎么激进怎么来<br> 集体项目在保守的大方向下前进</p>
</blockquote>
<p>如果是简单项目，只需要一个人来完成，比如说简单的活动页，后台管理页，这种需求往往一个人就做完了，不涉及配合的问题，试错成本小，那么激进无妨。</p>
<p>如果是集体项目，如果使用新技术涉及到团队的学习成本问题，成员间的沟通问题，而且非常容易牵一发而动全身，以前代码的兼容怎么办，用了太新的技术以后不好招人怎么办，都是需要考虑的问题，所以已经成熟的项目，前进要慎重。</p>
<h2 id="webpack能解决什么"><a href="#webpack能解决什么" class="headerlink" title="webpack能解决什么"></a>webpack能解决什么</h2><h3 id="速度"><a href="#速度" class="headerlink" title="速度"></a>速度</h3><p>我在一个自己负责的小项目中尝试了webpack的3.0版本，最直观感觉就是打包速度快了,之后我开始在主要项目中进行测试,在开发时，我需要起一个本地server</p>
<p>我主项目entry是20个文件，大小各异，样本多点我们好看对比。</p>
<p>我的主项目使用的是1.13.1<br><img src="http://odf9m3avc.bkt.clouddn.com/webpack1.jpeg" alt="enter description here"><br>毕竟涉及把所有文件写到虚拟内存里，有点慢</p>
<p>如果使用3.0<br><img src="http://odf9m3avc.bkt.clouddn.com/webpack2.jpeg" alt="enter description here"></p>
<p>这里启开发环境不涉及压缩混淆一类的就是过一下loader，差距还是很明显的；</p>
<p><strong>接下来我们看上线打包</strong><br>在1.X版本慢就慢在：<br><img src="http://odf9m3avc.bkt.clouddn.com/WechatIMG5.jpeg" alt="enter description here"></p>
<p>然后时间上是<br><img src="http://odf9m3avc.bkt.clouddn.com/WechatIMG4.jpeg" alt="enter description here"></p>
<p>所以每次改完bug打包都能喝个茶了…</p>
<p><img src="http://odf9m3avc.bkt.clouddn.com/c15d6d87ba59982405c8195ef4e0020e.jpeg" alt=""></p>
<p>然后如果使用3.0<br>当然也是有慢的地方的<br><img src="http://odf9m3avc.bkt.clouddn.com/WechatIMG6.jpeg" alt="enter description here"></p>
<p>但是！<br>时间快了20%所右</p>
<p><img src="http://odf9m3avc.bkt.clouddn.com/webapck3-time.jpg" alt=" "></p>
<h3 id="体积"><a href="#体积" class="headerlink" title="体积"></a>体积</h3><p>webpack3.0的新特性之一是 Scope Hoisting 译为 作用域提升<br>特别是这张图传的神乎其神<br><img src="http://odf9m3avc.bkt.clouddn.com/webpack3.0%E6%95%88%E6%9E%9C%E5%9B%BE.png" alt="enter description here"></p>
<p>近50%的体积减小，惊不惊喜，意不意外！这还有什么好犹豫的快上车啊！</p>
<p><img src="http://odf9m3avc.bkt.clouddn.com/webapck3.jpeg" alt=""></p>
<p><img src="http://odf9m3avc.bkt.clouddn.com/webpack1.13-220s.png" alt=" "></p>
<p><strong>嗯…好像哪里不太对</strong><br><img src="http://odf9m3avc.bkt.clouddn.com/hold2.png" alt="enter description here"><br><img src="http://odf9m3avc.bkt.clouddn.com/hold1.png" alt=" "></p>
<p>(╯‵□′)╯︵┻━┻ 这不对啊，你就优化了这1%？</p>
<h3 id="webapck到底优化了什么"><a href="#webapck到底优化了什么" class="headerlink" title="webapck到底优化了什么"></a>webapck到底优化了什么</h3><p>webpack3优化的原因是加入了Scope Hoisting 译为 作用域提升，我们来一起看看他到底做了什么</p>
<p>我们的实验如下,es6module对照组与webpack版本对照组，webpack3版本增加作用于提升插件<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test1</span></span><br><span class="line"><span class="keyword">var</span> foo = <span class="built_in">require</span>(<span class="string">"./module1"</span>)</span><br><span class="line"></span><br><span class="line">foo();</span><br><span class="line"><span class="comment">//module1</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">foo</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"hello world"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//test2.js</span></span><br><span class="line"><span class="keyword">import</span> foo <span class="keyword">from</span> <span class="string">"./module2"</span></span><br><span class="line">foo();</span><br><span class="line"><span class="comment">//module2</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"hello world"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//webpack.config for 1&amp;2</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry:&#123;</span><br><span class="line">		<span class="string">"es5"</span>:<span class="string">"./webpacktest/test1"</span>,</span><br><span class="line">        <span class="string">"es6"</span>:<span class="string">"./webpacktest/test2"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    output:&#123;</span><br><span class="line">       filename:<span class="string">"[name].bundle.js"</span></span><br><span class="line">    &#125;,</span><br><span class="line">	plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.optimize.ModuleConcatenationPlugin()<span class="comment">//for webpack3</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先我们一般都知道webapck处理依赖是将其封在一个独立闭包函数里面， 来完成依赖的独立作用域</p>
<p>然后ES5 与 ES6 的实现还有区别我们之后看</p>
<p>我们先说ES6module<br>webpack2 的打包情况</p>
<p>这里是2</p>
<p><img src="http://odf9m3avc.bkt.clouddn.com/note/20es6-webpack2.png" alt="enter description here" title="es6-webpack2"></p>
<p>这里是3</p>
<p><img src="http://odf9m3avc.bkt.clouddn.com/note/20es6-webpack3.png" alt="enter description here" title="es6-webpack3"></p>
<p><strong>敲黑板！！</strong><br>这里我们看出来webpack2为每一个闭包都加了一个<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>而webpack3把所有的依赖都打在了一个闭包里，那么你想，你一个组件要是个单页面应用那怎么不得十几个依赖，那就是十几个（function (module）…）<br>然后依赖再依赖别的这得多少啊…<br>Webpack 3 + ModuleConcatenationPlugin() 帮你全干掉，这就是为什么打包体积小了。</p>
<p>我们可以从下图看出来，es6.js 从3.17k 减少到了2.75k</p>
<p><img src="http://odf9m3avc.bkt.clouddn.com/note/20esmodule-webpack2.png" alt="enter description here" title="esmodule-webpack2"></p>
<p><img src="http://odf9m3avc.bkt.clouddn.com/note/20esmodule-webpack3.png" alt="enter description here" title="esmodule-webpack3"></p>
<hr>
<p>那有同学就问了，你说的这是2和3对比，1呢，我们来看实验</p>
<p><img src="http://odf9m3avc.bkt.clouddn.com/note/20esmodule-webapck1.png" alt="enter description here" title="esmodule-webapck1"></p>
<p><img src="http://odf9m3avc.bkt.clouddn.com/note/20%E6%83%8A%E4%B8%8D%E6%83%8A%E5%96%9C.jpg" alt="enter description here" title="惊不惊喜"></p>
<p>这不对啊，怎么1反而是最小的，这还升什么级，(╯‵□′)╯︵┻━┻。<br>我们来看1里面打出来是什么</p>
<p><strong>ES6module</strong></p>
<p><img src="http://odf9m3avc.bkt.clouddn.com/note/20es6-webpack1.png" alt="enter description here" title="es6-webpack1"></p>
<p><strong>ES5module</strong></p>
<p><img src="http://odf9m3avc.bkt.clouddn.com/note/20es5-webpack1.png" alt="enter description here" title="es5-webpack1"></p>
<p>这就要说到ES6module 的问题了，我们可以看到webpack1对es6module根本没有处理，那么这样的ES6代码，很多浏览器是不支持的，而2、3版本都对ES6module进行了处理</p>
<blockquote>
<p>原因是webpack1对es6module支持的很差，在2.1.0版本中的，才开始支持，其bugfixes写到<br><strong>It’s now possible to combine webpack ES2015 modules with babel ES2015 modules
</strong></p>
</blockquote>
<p>所以，在webpack1中传统的es5的方式，webpack对他进行了处理，和我们之前的结果一样，使用了闭包来保证独立作用域。</p>
<p><strong>那为什么webpack1实验结果体积最小呢</strong></p>
<p>是因为webpack在包里新加了一些getter setter方法用于优化依赖的加载</p>
<p><img src="http://odf9m3avc.bkt.clouddn.com/note/20webpack2-getter.png" alt="enter description here" title="webpack2-getter"></p>
<p>所以虽然在我们的实验中webpack1更小，但是在实际项目的结果中，webapck3的体积要比1要小。</p>
<p>而在我的项目中因为兼容原因没有使用ES6module所以优化效果比较差，所以如果项目中完全使用es6的话，那么就可以完全发挥ES6的威力。</p>
<h3 id="webpack3的单一闭包模式的问题"><a href="#webpack3的单一闭包模式的问题" class="headerlink" title="webpack3的单一闭包模式的问题"></a>webpack3的单一闭包模式的问题</h3><p>我们在这张图中可以看到</p>
<p><img src="http://odf9m3avc.bkt.clouddn.com/note/20es6-webpack3.png" alt="enter description here" title="es6-webpack3"></p>
<p>在webpack3中依赖存储于一个闭包，那么问题来了，在没有闭包的情况下，他们在同一个块级作用域，如果我在一个依赖里声明了一个变量，其他模块岂不是也能拿到？</p>
<p><strong>我们来搞事情</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test2.js</span></span><br><span class="line"><span class="keyword">import</span> foo <span class="keyword">from</span> <span class="string">"./module2"</span></span><br><span class="line">foo();</span><br><span class="line"><span class="built_in">console</span>.log(other)</span><br><span class="line"><span class="comment">//module2</span></span><br><span class="line"><span class="keyword">var</span> other = <span class="string">"The World"</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"hello world"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="http://odf9m3avc.bkt.clouddn.com/note/20webpack3-sco.png" alt="enter description here" title="webpack3-sco"></p>
<p>我们可以看出来，虽然没有了闭包，但是使用了另外的名字来保证了作用域。</p>
<h1 id="相关兼容性"><a href="#相关兼容性" class="headerlink" title="相关兼容性"></a>相关兼容性</h1><p>如果你决定升级了那么首先就要对配置文件进行一些更改，主要是 loader 与 plugins 的一些改变，语法上有一些不兼容。<br>另外webpack3的文档写的比1好多了，读起来清晰多了，所以基本的    api在这里不再赘述，这里列出来我遇到的一些问题</p>
<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><p>在打包或者建立服务器的时候可能会报找不到一些node的模块比如fs，这个时候需要在webpack文件里面这么设置<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">node:&#123;</span><br><span class="line">       <span class="built_in">console</span>: <span class="literal">true</span>,</span><br><span class="line">       fs: <span class="string">'empty'</span>,</span><br><span class="line">       net: <span class="string">'empty'</span>,</span><br><span class="line">       tls: <span class="string">'empty'</span>,</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure></p>
<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><p>babel-loader 官方推荐更新到7.1+<br>loader得到的souce从String改为了buffer对象，</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>所以说，总体上来说升级有一定收益，webpack官方也说webpack2可以直接升级webpack3，而webapck1升级也仅仅是一些api名字的变化。</p>
<p>如果用了es6那么升级就可以发挥他的威力。</p>
<p>而且webpack github上的issues 关于升级后的兼容性问题非常少，如果有时间的同学不妨一试。</p>
<p>参考：<br><a href="https://github.com/webpack/webpack/releases?after=v2.2.0-rc.0" target="_blank" rel="noopener">Releases · webpack_webpack</a><br><a href="https://medium.com/webpack/webpack-3-official-release-15fd2dd8f07b" target="_blank" rel="noopener">🍾🚀 webpack 3_ Official Release!! 🚀🍾 – webpack – Medium</a><br><a href="https://github.com/lishengzxc/bblog/issues/34" target="_blank" rel="noopener">https://github.com/lishengzxc/bblog/issues/34</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tuqiang.website/2017/06/18/re：从零开始构建技术团队/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yuri">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="住何乡">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/18/re：从零开始构建技术团队/" itemprop="url">如何构建一个优良的技术团队</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-18T00:00:00+08:00">
                2017-06-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="re-从零开始构建技术团队"><a href="#re-从零开始构建技术团队" class="headerlink" title="re:从零开始构建技术团队"></a>re:从零开始构建技术团队</h1><p>最近一直在招人，我也面了一些人，有一个问题一直没有解决</p>
<h2 id="我们需要什么样的小伙伴？"><a href="#我们需要什么样的小伙伴？" class="headerlink" title="我们需要什么样的小伙伴？"></a>我们需要什么样的小伙伴？</h2><p>真的只是简单的 器li大hai活好名校学霸就行了吗？</p>
<p>我们愿要相对技术差点，但是踏实肯干的人的深层原因是什么？</p>
<h3 id="优秀团队的定义"><a href="#优秀团队的定义" class="headerlink" title="优秀团队的定义"></a>优秀团队的定义</h3><p>我觉得一个优秀稳定的团队组成应该是这样的。<br><img src="http://odf9m3avc.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720170615220302.png" alt="此处输入图片的描述"></p>
<p>第一层是管理层，<br>名义管理者扮演技术经理的角色，它的任务就是 抗压、抢资源、谋福利、背锅。<br>技术专家比较好理解，就是负责解决团队生产开发中的难点，解决别人解决不了的事情。<br>这两个更多应该是刘备和诸葛亮的关系，名义上是刘备的部队，相对于具体的解决某个需求，更多的是应该 给技术团队争取福利、和其他部门对抗协调，阻止压力下泄到基层员工，让技术专家安心解决问题。他不需要代码写的多好，但一定要理解技术团队，绝对信任技术专家。<br>但是真正的任务管理者应该是技术专家。整个团队的走向，技术栈方向的选取，基层的培养，他是基层的引路人，带领初中级员工成长。</p>
<p>第二层是代理者，在第一层人员缺席时，他们能立刻顶上去，分担部分第一层的职责，不能让团队垮掉。在第三层人员数量不够时，能够高效率完成其工作。</p>
<p>第三层是基础层，主要是创新者与制造者，这两者都不可缺少，否则团队不稳。</p>
<p>制造者更偏向于注重细节，按时保质完成开发任务，对重复工作的耐受度高，他们是整个技术团队的本钱，按时交活儿，不犯错，这是最重要的；<br>优秀的制造者存在，管理者才能更好的去问上层要资源，要奖赏。</p>
<p>创新者更多的是技术专家的副手，当技术专家推出新技术新思想时，创新者需要多踩坑，多犯错，有着哪怕几天没有任何产出也能依靠热情继续debugger是最好的。填完了坑，提高制造者的效率，同时他们的存在营造良好的技术氛围，这就会成为工程师文化。创新者需要做的就是给团队带来长期收益的事情。</p>
<h2 id="收益的半衰期"><a href="#收益的半衰期" class="headerlink" title="收益的半衰期"></a>收益的半衰期</h2><p>同样收益的事情，我们应该做半衰期更长的。这是一个很常用的思考方式，同样适用于一个技术团队。<br>一个天天被产品的“紧急需求”压着的技术团队，很难得到比较快的发展，一个团队需要一部分人做一些长半衰期的事情。<br>我们团队的小伙伴孕育了 fakeux 框架来解决页面的复杂交互问题，推行了eslint来解决代码风格问题等等，在当初的时间节点这些东西甚至是负产出的，它增加了团队中的学习成本，影响了开发时间，但是一旦付出了学习成本之后，其收益是润物细无声的。这种长半衰期的收益也许它难以量化，但是却不可缺少。</p>
<hr>
<p>所以明确了我们需要什么人的时候，我们就能判断什么样的人才是我们需要的小伙伴了。</p>
<h3 id="这个人到底该不该要"><a href="#这个人到底该不该要" class="headerlink" title="这个人到底该不该要"></a>这个人到底该不该要</h3><p>一般情况下，应届生的水平差距不会太大，那么这时候一些 非硬性素质就会凸显出其比重，不管身份如何我觉得比较重要的是：</p>
<ol>
<li>技术敏感性<br>对新技术的接受程度，是否乐于接触了解新技术；<br>新的类库出来了，你会不会去了解一下他的用法呢，会不会想着与自己熟悉的技术进行对比？<br>不能惧怕新技术，抱着自己会的一亩三分地过着老婆孩子热炕头的清闲生活可以舒服一时，但是长久看来是不符合技术团队的高速发展的。</li>
<li>学习能力<br>一方面是表达，能不能给别人讲清楚<br>应届生的博客大多喜欢写知识总结，成体系的比较少，老实说没啥太大意思。<br>能写出解决问题的思路与方法的，大加分项。<br>另一方面就是速度。</li>
</ol>
<p>所以，在硬性的技术基础要求达标之后，往往就可以看我们的团队缺什么人了。<br>做需求的制造者是需要的，营造气氛的创新者也是不可或缺的。<br>打江山容易守江山难，招人容易管理难，我相信能打硬仗胜仗的队伍是不能靠随便招几个熟练工就可以的。</p>
<p>以上就是我在日常工作中的经验总结了，毕竟不是专业学人力的，也没见过什么大世面，权当抛砖引玉了~</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tuqiang.website/2017/05/10/EffectiveCanvas - 2Dcanvas优化思路/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yuri">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="住何乡">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/10/EffectiveCanvas - 2Dcanvas优化思路/" itemprop="url">EffectiveCanvas - 2Dcanvas优化思路</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-10T00:00:00+08:00">
                2017-05-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文章尝试解决以下问题：</p>
<ol>
<li>canvas的卡顿原因</li>
<li>分析性能瓶颈的思路</li>
</ol>
<p>Canvas是HTML5的新增特性之一，其允许我们来进行酷炫的图形绘制，从而完成渲染动画的需求。渲染动画的本质就是擦除与重绘，其频率就是帧速率，帧速率决定了留给每帧动画的渲染时间。如果消耗的时间稍微多了一些，就会产生卡顿。</p>
<h1 id="卡顿的原因"><a href="#卡顿的原因" class="headerlink" title="卡顿的原因"></a>卡顿的原因</h1><p>卡顿有两种：<br>我们在一帧中需要完成两件事情 1.计算 2. 渲染<br>这两个阶段都可以引起卡顿。</p>
<ol>
<li><p>由计算过程产生的卡顿，一般是一次性发生的。</p>
<p> 计算过程做了什么呢？业务逻辑、坐标计算、对象状态等。</p>
</li>
<li><p>由渲染过程产生的卡顿，一般称之为掉帧，它是周期性发生的。</p>
<p> 渲染过程本质上也有两个过程。</p>
<ol>
<li><p>js调用DOM API 及 Canvas API 进行渲染。</p>
</li>
<li><p>GPU渲染进程把渲染后的结果呈现在屏幕上的过程。</p>
</li>
</ol>
</li>
</ol>
<p>那么问题来了，我们以60FPS帧速率为例，每帧16ms，那么在这短短的16ms中你需要完成 ：上面的步骤1与2.1。如果不能完成，就会导致浏览器js主线程的阻塞。<br>但是渲染的开支比计算大几个数量级，那么其实我们的目标就缩小了，除非你的算法非常耗时，那么主要优化渲染性能。</p>
<p>那么时间都去哪儿了？</p>
<h1 id="渲染"><a href="#渲染" class="headerlink" title="渲染"></a>渲染</h1><p>我们来看渲染耗费时间都耗哪去了。</p>
<h2 id="API操作"><a href="#API操作" class="headerlink" title="API操作"></a>API操作</h2><p>与我们平时感觉到的不同，在canvas中对context赋值的操作是一个非常费时的行为，我简单做了个实验。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> n = <span class="number">1000000</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i &lt; n;i++)&#123;</span><br><span class="line">    a.b = <span class="number">2</span>;<span class="comment">//普通对象赋值 2ms</span></span><br><span class="line">    ctx.lineWidth = <span class="literal">null</span>;     <span class="comment">//40ms    非法70-400</span></span><br><span class="line">    ctx.fillStyle = <span class="literal">null</span>      <span class="comment">//130ms+  非法500-1000+</span></span><br><span class="line">    ctx.textAlign = &#123;&#125;;       <span class="comment">//70ms+   非法300+</span></span><br><span class="line">    ctx.shadowBlur = <span class="literal">null</span>;    <span class="comment">//30+     非法100+</span></span><br><span class="line">    ctx.shadowColor = <span class="number">1</span>       <span class="comment">//200+    非法350+</span></span><br><span class="line">    ctx.font = <span class="literal">null</span>;          <span class="comment">//1000+   非法2000+</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而且如果这些行为在save/restore中，会使s/r的时间开销增加600ms+；<br>虽然和真正的绘制相比，赋值开销是微不足道的，但是也架不住多啊，往往滥用赋值的情况在对象遍历，动画流程中会发生。<br>在我们对一个精灵对象进行绘制的时候，可能很多实例都是同样的状态，如果我们直接在渲染流程中进行状态赋值，那么就导致了遍历过程中的重复赋值；<br>在动画流程中，我们善用save/restore可以有效避免重复赋值，但也要小心的是不要滥用s/r，他们也是有开销的。<br>所以在开发中，为了减少渲染开销，尽量减少对ctx的赋值操作，可以考虑把功能实现转嫁给计算解决。</p>
<h2 id="渲染呈现"><a href="#渲染呈现" class="headerlink" title="渲染呈现"></a>渲染呈现</h2><p>减少渲染开销主要是：离屏、双缓冲、分层，这三种方法也经常混淆。</p>
<h3 id="离屏"><a href="#离屏" class="headerlink" title="离屏"></a>离屏</h3><p>离屏本质上是我们在内存里又开了一块canvas画布，但是又不把他插入到DOM中去，因为在内存中进行渲染和绘制略快于我们视野内的canvas。（我做了个实验，同样的10万次绘制内存要快1500ms左右）而且通过和drawImage使用能把多次绘制合并为一次绘制，减少了2.2步骤的开支。这就是双缓冲了。</p>
<h3 id="双缓冲"><a href="#双缓冲" class="headerlink" title="双缓冲"></a>双缓冲</h3><p>双缓冲机制并不是银弹。<br>如果你实际去使用双缓冲，把画好的整个离屏canvas绘制到视野canvas，你会发现性能反而比之前差得多。</p>
<p>为什么？</p>
<p><strong>因为各大浏览器厂商在实现canvas元素的时候，已经使用了双缓冲机制，</strong> 开发者再实现一遍反而会导致性能的下降，而且这没有任何的好处。</p>
<h3 id="浏览器双缓冲机制"><a href="#浏览器双缓冲机制" class="headerlink" title="浏览器双缓冲机制"></a>浏览器双缓冲机制</h3><p>浏览器在处理对Canvas 2D和WebGL的加速时，他们的绘制会直接使用GPU，所以他们一般会有一个<a href="http://www.songho.ca/opengl/gl_fbo.html" target="_blank" rel="noopener">GL FBO</a>（FrameBufferObject）作为自己的缓存（作用上类似离屏），而我们绘制的内容实际上是在FBO上绘制的，你看到的实际上是这个缓冲区的复制。</p>
<p>那么，该怎么用双缓冲呢？<br>双缓冲的正确兹识应该是配合drawImage将离屏的某个图块复制到视野canvas，这是可以提高绘制效率的。</p>
<h3 id="分层"><a href="#分层" class="headerlink" title="分层"></a>分层</h3><p>这在游戏开发中很常见，就像PS一样，不同图层负责不同功能，背景层可以只渲染不擦除，来完成减少开销。<br>但是，就我日常更多是web开发，这点我觉得有可以改进地方。<br>我们取其思路，不取其方法。因为web开发背景的变动没有游戏开发那么频繁，再加一块canvas的支出着实是有点杀敌一千自伤八百了。而且我们还有CSS也可以用GPU加速。<br>所以在web开发中，我们完全可以尝试将背景层提取为一个图片，配合CSS来完成我们的需求，我们可以再离屏中进行绘制背景，通过toDataUrl或者toBlob来将离屏canvas图像转化为png/jpg文件，不过blob兼容性只到IE10,但它可以生成jpg图片。<br>我们将不动的图片作为背景，真正需要变化的像素在canvas绘制，这样就可以节省一部分渲染开销。</p>
<h1 id="计算"><a href="#计算" class="headerlink" title="计算"></a>计算</h1><p>计算优化是个玄学啊（逃…</p>
<p>计算的卡顿一般出现在动画“生命周期”改变的时候，比如动画某时突然需要绘制非常多的动画，这时在一次raf中造成过大计算量，导致超过16ms，阻塞了raf的执行，这就会早一次性的比较长的一次卡顿，和渲染导致的周期性卡顿完全不一样，也是我们判断瓶颈的思路之一。</p>
<p>那么一方面，我们需要把 生成 -计算-渲染 分开，就像玩游戏最开始要有loading一样，我们需要把生产对象的过程从渲染周期中抽离出来，减少动画过程中的开销。<br>另一方面如果碰到实在需要复杂计算的地方，如果没有兼容性要求，worker是一个不错的选择</p>
<h2 id="web-worker"><a href="#web-worker" class="headerlink" title="web worker"></a>web worker</h2><p>worker兼容到IE10，它可以为你开一条系统进程来处理你的计算，从而根本上的解决计算开销，真是好东西啊。而且worker脚本中拿不到window和document ，就算你想搞事情也不是那么容易的。<br>需要注意的是，你的worker脚本可以理解在另一个环境跑的，所以在new Worker（“worker.js”）给脚本的时候，这个脚本不通过require和import加载，不过webpack的loader处理，需要单独作为entry生成。</p>
<p>另一方面，WebAssembly 也可以配合使用，那时就可以处理更大的数据量了，不过WASM这东西兼容性太差，可以期待一下。</p>
<h3 id="替代方案：分步"><a href="#替代方案：分步" class="headerlink" title="替代方案：分步"></a>替代方案：分步</h3><p>如果你有兼容性要求，那么大计算量就只能分步处理了，<br>把计算步骤分割到各个raf中，每次完成一部分，来达到消除开销的目的，<br>但是这真的太麻烦了，一方面带来了代码的臃肿，另一方面自己的功力要求有点高。<br>如果真的万不得已到了这步…也许好好和你的PM沟通一下更好。</p>
<h1 id="道"><a href="#道" class="headerlink" title="道"></a>道</h1><p>说了很多“术”的东西，我想暨越说说“道”的问题。<br>真正阻塞我们的不是技术或知识， 而是我们的思维。<br>当你尝试了各种优化方法还是差强人意的时候，更多该想想是不是又面向过程编码了？<br>是不是又写着一边喝水一边炒菜的函数，自己还觉得很正常？<br>本来可以一个对象解决的事情，你却实例了多个？</p>
<p>不能用战术上的勤奋掩盖战略上的懒惰。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tuqiang.website/2017/05/08/私募页动画重构思路/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yuri">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="住何乡">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/08/私募页动画重构思路/" itemprop="url">私募页动画重构思路</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-08T00:00:00+08:00">
                2017-05-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>私募页动画是一个很有意思的需求<br>在开发时有很多稚嫩和值得反思的地方<br>在重构的过程中，也逐步反思之前的写法</p>
<p>预览：<a href="http://118.186.218.30" target="_blank" rel="noopener">人人智慧私募</a><br>之前的版本是：<a href="https://github.com/YuriTu/In-RENN/tree/master/canvas" target="_blank" rel="noopener">原版动画</a><br>重构后版本：<a href="https://github.com/YuriTu/In-RENN/tree/master/newPEcanvas" target="_blank" rel="noopener">新版动画</a></p>
<p>虽然很吃藕，但是毕竟是自己设计的，我觉得还是挺酷炫的<br>我又不是UI ┑(￣Д ￣)┍ （逃…</p>
<h1 id="寻找问题"><a href="#寻找问题" class="headerlink" title="寻找问题"></a>寻找问题</h1><p>然后我发现它是非常卡顿的，主要表现在</p>
<ol>
<li>cpu耗费，烧得我整个mac都烫了….当时没看，我估计cpu得有70%</li>
<li>区区一个网页，chrome占了300多内存</li>
<li>FPS只有7左右，也就是说，一帧花费150ms左右</li>
</ol>
<p>(╯‵□′)╯︵┻━┻  这一下一点都不酷炫了好么<br>  ┬─┬ ノ(‘-‘ノ)  扶好扶好…我们想想办法</p>
<p>  两个地方： 计算 渲染<br>理论上来说，渲染远大于计算，但是根据chrome 的工具来看，我的计算耗费赶上了渲染</p>
<h1 id="分析问题"><a href="#分析问题" class="headerlink" title="分析问题"></a>分析问题</h1><h2 id="不必要计算"><a href="#不必要计算" class="headerlink" title="不必要计算"></a>不必要计算</h2><p><img src="http://odf9m3avc.bkt.clouddn.com/index.gif" alt="img"><br>开始的进入动画都是简单的画圆环，移圆弧，都不是性能的瓶颈，他们计算渲染花费都很少，瓶颈就在最后生成的光晕那里。</p>
<p>这里最后的循环动画有三个构成部分</p>
<ol>
<li>文字、中心圆环，有个圆形渐变，费性能吗？费，但是不至于这么卡.</li>
<li>阴影与文字：阴影是个性能大户，但是因为有响应式问题，不能把阴影转嫁给其他组件</li>
<li>光环本身，所有的断点与动态的条纹都是通过计算坐标所得的，那么那么每帧计算量就达到了 4000次以上，而且为了减少计算难度通过旋转坐标轴绘制，这也是一个支出。</li>
</ol>
<p>无论是背景的光环，还是动态的条纹，我都是实例了50个对象来处理的，这个对象的遍历，也是一个消耗点。<br>而且其实除了动态的条纹，这是一个背景性质的东西，理论上渲染一次就行了，其他的就是旋转了，而目前的方案是每帧重绘，这个支出不应该。<br>动态的条纹，其实本质上是一个遮罩，我在想有必要要那么多的实例对象嘛？可以用一个实例对象来解决吗？</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>不动的光环背景，我本来是打算使用分层处理的，那么只需要渲染一遍，就把其所在的canvas作为背景，不需要再渲染。<br>不可行的原因有二，<br>canvas画布本身的支出，两个canvas画布对性能又是一个大支出。<br>二者，我需要背景的旋转，旋转速度与上层画布同步，那么还是要渲染-擦除，仅仅减少了后续的计算支持，本质问题没有解决。</p>
<p>于是，我打算使用css，css的transform中的3dAPI也可以使用GPU加速。<br>于是我，通过使用一张离屏Canvas，将背景绘制完成，离屏Canvas因为在内存中，绘制速度比在DOM中的canvas快得多，不过记得用完记得干掉，免得内存泄露。<br><img src="http://odf9m3avc.bkt.clouddn.com/QQ20170508-0.png" alt="enter description here"></p>
<p>通过toDataURL把整个canvas抽成base64，（当然你也可以用toBlob，不过他兼容性不好，）再直接加一个img标签就完成了canvas画布的背景。这个性能支持由canvas转嫁给了css，提高了很多性能。</p>
<p>另一个可以减少计算的地方就是动态的条纹，以前是每帧计算每个条纹的四个坐标点的，还包括三角函数、浮点计算，这个计算强度一下就上去了。<br>经过大牛指点，我才用了遮罩的方式，<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.stripeList.forEach(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">                ctx.beginPath();</span><br><span class="line">                ctx.rect(<span class="keyword">this</span>.initLB.x + <span class="number">3</span>, item.stepLB.y, <span class="number">40</span>, <span class="number">10</span>);</span><br><span class="line">                ctx.closePath();</span><br><span class="line">                ctx.fill();</span><br><span class="line">                item.stepLB.y -= <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">if</span> ( item.stepLB.y &lt; <span class="number">40</span>)&#123;</span><br><span class="line">                    item.stepLB.y = <span class="number">600</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br></pre></td></tr></table></figure></p>
<p>因为我绘制背景的时候，已经计算完成了其可见范围的坐标，这相当于已经有了他的遮罩，我其实不用管具体的宽度，给予最大宽度，通过clip进行展示就可以的。<br>这样也就是减少了这部分的计算支出。</p>
<h2 id="计算分步"><a href="#计算分步" class="headerlink" title="计算分步"></a>计算分步</h2><p>我所有的计算都是在中心圆变成光环进行计算的，导致一进入这一步，把进程就阻塞完了。我觉得这个计算应该是可以转移到其他部分的，比如刚开始</p>
<h3 id="web-worker"><a href="#web-worker" class="headerlink" title="web worker"></a>web worker</h3><p>终于不用兼容IE8啦！！！！！<br>那还犹豫什么，黑科技往上怼。<br>诚然把计算量大的步骤，均摊给整个动画流程是个不错的办法，但是一个是写起来麻烦，另一个是数据管理费劲。<br>干脆交给另一个进程好了，这样本质上把MVC完全分开，worker和配置文件作为数据层，动画逻辑负责控制渲染流程，渲染文件仅接受数据，整体作为单一数据流，就像React的思想一样，非常方便控制。</p>
<h2 id="渲染性能"><a href="#渲染性能" class="headerlink" title="渲染性能"></a>渲染性能</h2><p>渲染性能控制都是一些程式化的东西了，无非是减少API操作和不必要的赋值，这个时候就体现出了活用save\restore的优势了…当然要是你滥用save…那也没办法了。</p>
<p>另外一个“道”上的思维就是说，避免无谓的绘制，这个往往在一个巨无霸函数中体现，我们尽量一个函数干一个事，一边吃饭一边炒菜的代码很多，但你自己往往发现不了，还觉得很对。</p>
<h2 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h2><p>最开始写这个动画逻辑的时候，还是非常傻得，干了很多面对过程的事情。而且有一种拆东墙补西墙的感觉，怎么写都不对劲，这个时候一定好好想想是不是自上而下编码了。<br>其实这个动画我觉得还是可以优化的， 但是我算法实在不行，这是之后一个需要多锻炼的地方。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tuqiang.website/2017/04/06/人人金服前端架构演变之路/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yuri">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="住何乡">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/06/人人金服前端架构演变之路/" itemprop="url">人人金服前端架构演变之路</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-06T00:00:00+08:00">
                2017-04-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/随笔/" itemprop="url" rel="index">
                    <span itemprop="name">随笔</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>2016年人人公司年刊投稿</p>
</blockquote>
<p>2016年是前端技术井喷的一年，大量框架规范逐渐落地，渐渐的推动整个平台格局变化，使整个前端的生态获得了新的发展。人人金服前端团队，也跟随着整个前端的技术发展方向，在今年5月进行了整个前端项目的重构，意在用新技术解决日益增加历史包袱与性能问题。</p>
<p>1.披荆斩棘，开天辟地</p>
<p>在过去的项目中，使用的是比较传统的Jquery + requireJs + gsp 的技术栈，在过去的开发环境下有着 易于上手、兼容性强、开发规范完备等一些优点，在项目的开拓时期，为整个项目的高速迭代勇敢试错提供了简单高效的解决方案。也同时奠定了整个项目的基础，在对兼容性的踩坑过程中，整个团队积累了很多的经验，也有对组件化的需求和尝试。</p>
<p>但是在业务日渐庞大的过程中，曾经的技术选型渐渐与新的业务环境有了不兼容性，最明显的就是性能的瓶颈。金融项目的前端页面作为进行数据可视化的桥梁，有着数据来源多，数据量大，巨额的渲染性能耗费，交互复杂等特点。</p>
<p>团队在业务开发的过程中发现，业务逻辑异常复杂臃肿，模块颗粒度大，复用程度差的种种问题，以及为了IE8兼容所作出的针对各平台“使用共性而放弃特性”的做法都在进一步加剧上述问题的优化难度，种种的历史包袱与性能瓶颈让前端团队意识到重构的必要性。</p>
<p>2.凤凰涅槃，锐意革新</p>
<p>此时，谷歌出品Angular风头正盛，有着脸书做信任背书的React也逐步进入我们的视野，主打轻量的Vue也非常有吸引力。最后，在React与Vue的选择中，团队选择了React，主要是因为：1.React本身的虚拟DOM对高性能的有力支持，单一数据流对数据交互的友好 2.React本身的跨端能力、更方便的组件化 3.丰富的polyfil能达到对IE8兼容的需要。</p>
<p>在今年5月，整个团队对前端项目进行了重构，采用了ES6 + React + webpack的技术栈。使用新技术对整个团队是编程方式上的革新，首先是从传统的面对对象向函数式编程过渡，在新的框架中，因为采用单一数据流，从而对状态的设计关乎整个组件的质量，关注点从业务逻辑分离，而是关注于数据的变化，摆脱了Jquery时代复杂的交互管理与DOM操作，从而提升了性能；其次，是编程思维的转变，对于每个组件力求抽象化构建而是不是采用暴力算法进行开发，完备的组件文档，数据设计，从而让复用的小伙伴减少学习成本，提高了整个项目的组价复用率，缩短了项目开发时间。</p>
<p>选择了React，也就是选择了React全家桶，在对性能的优化中，逐步试水Redux框架来进行进一步mvc分离，统一管理state；弃用臃肿缓慢的npm而改用更加轻量快速的yarn来管理依赖；使用eslint来规范团队代码风格，开发中进行review机制，降低新人的学习成本。在对项目进行逐步的工程化、规范化、模块化。</p>
<p>3.批隙导窾，竿头日进</p>
<p>在这一年中我们对项目进行了凤凰涅槃般的革新，取得了丰厚的硕果，也发现了自身的不足，在开发过程渐渐步入稳健之时，我们也对自己提出了新的要求，自动化测试、打包优化、自动化部署、前后端进一步分离，都是整个团队着力解决的问题。以在接下来的一年为人人金服提供更稳定、高效的技术支持。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tuqiang.website/2017/03/09/译注-React最佳实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yuri">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="住何乡">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/09/译注-React最佳实践/" itemprop="url">译注React最佳实践</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-09T00:00:00+08:00">
                2017-03-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文地址：<a href="https://github.com/planningcenter/react-patterns" target="_blank" rel="noopener">react-patterns</a></p>
<hr>
<p>这篇文章主要讲的是在React组件开发中的一些规范，我也将其实践于项目中，结合我在项目中的实践进行了一些批注，意欲解释其为什么要这么做，希望能给新开发react的小伙伴有一些帮助。</p>
<p>渣翻见谅…</p>
<hr>
<p><em>React最佳实践</em></p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#概述">概述</a></li>
<li>组件的组织结构<ol>
<li><a href="#基础组件结构">基础组件结构</a></li>
<li><a href="#规范props格式">规范props格式</a></li>
</ol>
</li>
<li>推荐模式<ol>
<li><a href="#props数据的处理">Props数据的处理</a></li>
<li><a href="#state数据的处理">State数据的处理</a></li>
<li><a href="#在render方法中使用三元表达式">在render方法中使用三元表达式</a></li>
<li><a href="#view层组件">View层组件</a></li>
<li><a href="#容器组件">容器组件</a></li>
</ol>
</li>
<li>反模式<ol>
<li><a href="#条件判断语句">条件判断语句</a></li>
<li><a href="#不要在render方法中缓存数据">不要在 render 方法中缓存数据</a></li>
<li><a href="#存在性检验">存在性检验</a></li>
<li><a href="#根据props来设置state">根据props来设置state</a></li>
</ol>
</li>
<li>实例<ol>
<li><a href="#合理命名事件处理函数">合理命名事件处理函数</a></li>
<li><a href="#对event合理命名">对event合理命名</a></li>
<li><a href="#使用proptype">使用propType</a></li>
<li><a href="#使用实体字符">使用实体字符</a></li>
</ol>
</li>
<li>坑<ol>
<li><a href="#表格">表格</a></li>
</ol>
</li>
<li>工具库<ol>
<li><a href="#classnames库">classNames库</a></li>
</ol>
</li>
<li>其他<ol>
<li><a href="#jsx">JSX</a></li>
<li><a href="#es2015">ES2015</a></li>
<li><a href="#react-rails">react-rails</a></li>
<li><a href="#rails-assets">rails-assets</a></li>
<li><a href="#flux">flux</a></li>
</ol>
</li>
</ol>
<hr>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本文讨论我们如何正确的在Rails框架中编写<a href="https://facebook.github.io/react/" target="_blank" rel="noopener">React.js</a>。我们一直在努力寻找最优雅的方式去编写React组件，在多次的失败尝试之后，我们得出了以下这些所推荐的方式；如果有的地方看起来不太适合，那么他可能真的不合适。希望你能让我们也知道哪些地方不合适。</p>
<p>所有的例子基于ES2015语法编写，使用 <a href="http://babeljs.io/" target="_blank" rel="noopener">babel</a>转译以及采用<a href="https://github.com/reactjs/react-rails" target="_blank" rel="noopener">react-rails gem</a>框架。</p>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<hr>
<h2 id="基础组件结构"><a href="#基础组件结构" class="headerlink" title="基础组件结构"></a>基础组件结构</h2><ul>
<li>class的定义<ul>
<li>constructor<ul>
<li>事件绑定</li>
</ul>
</li>
<li>组件生命周期事件</li>
<li>get/set 数据处理函数</li>
<li>render 方法</li>
</ul>
</li>
<li>defaultProps</li>
<li>proptypes</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> (props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.state = &#123; <span class="attr">smiling</span>: <span class="literal">false</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.handleClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123;<span class="attr">smiling</span>: !<span class="keyword">this</span>.state.smiling&#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillMount () &#123;</span><br><span class="line">    <span class="comment">// 事件监听 （flux/reduce 的Store、WebSocket、document等） </span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount () &#123;</span><br><span class="line">    <span class="comment">// React.getDOMNode() DOM操作等相关逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillUnmount () &#123;</span><br><span class="line">    <span class="comment">// 移除事件监听 </span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  get smilingMessage () &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">this</span>.state.smiling) ? <span class="string">"is smiling"</span> : <span class="string">""</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div onClick=&#123;<span class="keyword">this</span>.handleClick&#125;&gt;</span><br><span class="line">        &#123;<span class="keyword">this</span>.props.name&#125; &#123;<span class="keyword">this</span>.smilingMessage&#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">Person.defaultProps = &#123;</span></span><br><span class="line"><span class="regexp">  name: 'Guest'</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">Person.propTypes = &#123;</span></span><br><span class="line"><span class="regexp">  name: React.PropTypes.string</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>译注：<br>在willMount 生命周期中virtualDom已经完成，所以可以进行事件绑定<br>在DidMount 中组件已经被渲染，此时可以用this.refs了，写canvas的同学要注意这点。</p>
</blockquote>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<h2 id="规范Props格式"><a href="#规范Props格式" class="headerlink" title="规范Props格式"></a>规范Props格式</h2><p>两个及以上props换行书写。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// bad</span><br><span class="line"><span class="tag">&lt;<span class="name">Person</span></span></span><br><span class="line"><span class="tag"> <span class="attr">firstName</span>=<span class="string">"Michael"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">// good</span><br><span class="line"><span class="tag">&lt;<span class="name">Person</span> <span class="attr">firstName</span>=<span class="string">"Michael"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// bad</span><br><span class="line"><span class="tag">&lt;<span class="name">Person</span> <span class="attr">firstName</span>=<span class="string">"Michael"</span> <span class="attr">lastName</span>=<span class="string">"Chan"</span> <span class="attr">occupation</span>=<span class="string">"Designer"</span> <span class="attr">favoriteFood</span>=<span class="string">"Drunken Noodles"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">// good</span><br><span class="line"><span class="tag">&lt;<span class="name">Person</span></span></span><br><span class="line"><span class="tag"> <span class="attr">firstName</span>=<span class="string">"Michael"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">lastName</span>=<span class="string">"Chan"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">occupation</span>=<span class="string">"Designer"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">favoriteFood</span>=<span class="string">"Drunken Noodles"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<hr>
<h2 id="Props数据的处理"><a href="#Props数据的处理" class="headerlink" title="Props数据的处理"></a>Props数据的处理</h2><p>使用 Get/Set访问器属性 来做数据处理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bad</span></span><br><span class="line">firstAndLastName () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.props.firstName&#125;</span> <span class="subst">$&#123;<span class="keyword">this</span>.props.lastname&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// good</span></span><br><span class="line">get fullName () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.props.firstName&#125;</span> <span class="subst">$&#123;<span class="keyword">this</span>.props.lastname&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参阅：反模式- <a href="#不要在render方法中缓存数据">不要在 render 方法中缓存数据</a></p>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<hr>
<h2 id="State数据的处理"><a href="#State数据的处理" class="headerlink" title="State数据的处理"></a>State数据的处理</h2><p>数据处理函数的命名应该在开头处添加一个动词，以增加可读性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bad</span></span><br><span class="line">happyAndKnowsIt () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.state.happy &amp;&amp; <span class="keyword">this</span>.state.knowsIt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// good</span></span><br><span class="line">get isHappyAndKnowsIt () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.state.happy &amp;&amp; <span class="keyword">this</span>.state.knowsIt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的对象方法<em>必须</em>返回一个<code>布尔值</code>。</p>
<blockquote>
<p>译注：<br>这里想表达的是，state做为管理组件状态的数据，数据结构应该尽量简单，清晰的表示组件状态，复杂的业务逻辑应该放在父组件通过props传递的方式来获得，所以作者推荐state的处理必须返回布尔值。</p>
</blockquote>
<p>参阅: 反模式-<a href="#条件判断语句">条件判断语句</a></p>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<h2 id="在render方法中使用三元表达式"><a href="#在render方法中使用三元表达式" class="headerlink" title="在render方法中使用三元表达式"></a>在render方法中使用三元表达式</h2><p>在<code>render</code>中使用三元表达式来完成渲染判断。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bad</span></span><br><span class="line">renderSmilingStatement () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">strong</span>&gt;</span>&#123;(this.state.isSmiling) ? " is smiling." : ""&#125;<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span>;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">render () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;this.props.name&#125;&#123;this.renderSmilingStatement()&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// good</span></span><br><span class="line">render () &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &#123;<span class="keyword">this</span>.props.name&#125;</span><br><span class="line">      &#123;(<span class="keyword">this</span>.state.smiling)</span><br><span class="line">        ? <span class="xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span>is smiling<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">        : <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<h2 id="View层组件"><a href="#View层组件" class="headerlink" title="View层组件"></a>View层组件</h2><p>以view层为基本最小单元来组织组件。不要创建只能一次性使用的巨无霸组件以及域组件 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bad</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PeopleWrappedInBSRow</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">"row"</span>&gt;</span><br><span class="line">        &lt;People people=&#123;<span class="keyword">this</span>.state.people&#125; /&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// good</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BSRow</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"row"</span>&gt;</span>&#123;this.props.children&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeView</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;BSRow&gt;</span><br><span class="line">        &lt;People people=&#123;<span class="keyword">this</span>.state.people&#125; /&gt;</span><br><span class="line">      &lt;<span class="regexp">/BSRow&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<h2 id="容器组件"><a href="#容器组件" class="headerlink" title="容器组件"></a>容器组件</h2><blockquote>
<p>使用一个父级容器来进行数据请求，然后用子级组件来进行对应的渲染 &mdash; Jason Bonta</p>
</blockquote>
<h4 id="Bad"><a href="#Bad" class="headerlink" title="Bad"></a>Bad</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CommentList.js</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentList</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  getInitialState () &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">comments</span>: [] &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount () &#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">      url: <span class="string">"/my-comments.json"</span>,</span><br><span class="line">      dataType: <span class="string">'json'</span>,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">comments</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">comments</span>: comments&#125;);</span><br><span class="line">      &#125;.bind(<span class="keyword">this</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;ul&gt;</span><br><span class="line">        &#123;<span class="keyword">this</span>.state.comments.map(<span class="function">(<span class="params">&#123;body, author&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;body&#125;—&#123;author&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span>;</span><br><span class="line">        &#125;)&#125;</span><br><span class="line">      &lt;<span class="regexp">/ul&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="Good"><a href="#Good" class="headerlink" title="Good"></a>Good</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CommentList.js</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentList</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;ul&gt;</span><br><span class="line">        &#123;<span class="keyword">this</span>.props.comments.map(<span class="function">(<span class="params">&#123;body, author&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;body&#125;—&#123;author&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span>;</span><br><span class="line">        &#125;)&#125;</span><br><span class="line">      &lt;<span class="regexp">/ul&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CommentListContainer.js</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentListContainer</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  getInitialState () &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">comments</span>: [] &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount () &#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">      url: <span class="string">"/my-comments.json"</span>,</span><br><span class="line">      dataType: <span class="string">'json'</span>,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">comments</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">comments</span>: comments&#125;);</span><br><span class="line">      &#125;.bind(<span class="keyword">this</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">CommentList</span> <span class="attr">comments</span>=<span class="string">&#123;this.state.comments&#125;</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p><a href="https://medium.com/@learnreact/container-components-c0e67432e005" target="_blank" rel="noopener">了解更多</a><br><a href="https://www.youtube.com/watch?v=KYzlpRvWZ6c&amp;t=1351" target="_blank" rel="noopener">观看相关视频</a></p>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<hr>
<h2 id="不要在render方法中缓存数据"><a href="#不要在render方法中缓存数据" class="headerlink" title="不要在render方法中缓存数据"></a>不要在render方法中缓存数据</h2><p>不要在 <code>render</code>方法中进行数据处理、state/props的保存。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bad</span></span><br><span class="line">render () &#123;</span><br><span class="line">  <span class="keyword">let</span> name = <span class="string">`Mrs. <span class="subst">$&#123;<span class="keyword">this</span>.props.name&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// good</span></span><br><span class="line">render () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;`Mrs. $&#123;this.props.name&#125;`&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// best</span></span><br><span class="line">get fancyName () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`Mrs. <span class="subst">$&#123;<span class="keyword">this</span>.props.name&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">render () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;this.fancyName&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>我认为这样的风格是为了性能考量。</em></p>
<p>参阅：推荐模式- <a href="#props数据的处理">props数据的处理</a></p>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<h2 id="条件判断语句"><a href="#条件判断语句" class="headerlink" title="条件判断语句"></a>条件判断语句</h2><p>不要在 <code>render</code>方法中写判断语句，多采用三元或短路。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bad</span></span><br><span class="line">render () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;if (this.state.happy &amp;&amp; this.state.knowsIt) &#123; return "Clapping hands" &#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// better</span></span><br><span class="line">get isTotesHappy() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.state.happy &amp;&amp; <span class="keyword">this</span>.state.knowsIt;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">render() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;(this.isTotesHappy) &amp;&amp; "Clapping hands"&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个情况最好的方法就是使用 <a href="#容器组件">父组件容器</a>来管理state，新的state数据作为props传给子组件。</p>
<p>参阅: 推荐模式- <a href="#state数据的处理">State数据的处理</a></p>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<h2 id="存在性检验"><a href="#存在性检验" class="headerlink" title="存在性检验"></a>存在性检验</h2><p>不要在根组件检查存在性。<br>使用函数式编写无状态组件时，返回的数据类型应该恒定。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bad</span></span><br><span class="line"><span class="keyword">const</span> Person = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line"><span class="comment">//原文为this.props.firstName 为原作者笔误，故改正</span></span><br><span class="line">  <span class="keyword">if</span> (props.firstName)</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;props.firstName&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有组件都<em>必须</em>被渲染。<br>所以可以增加一个自己觉得合适的默认值——<code>defaultProps</code>。</p>
<blockquote>
<p>译注：<br>所有组件都进行渲染主要是为了方便进行控制和管理。<br>即不需要呈现的组件，渲染为一个空标签即可。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// better</span></span><br><span class="line"><span class="keyword">const</span> Person = <span class="function"><span class="params">props</span> =&gt;</span></span><br><span class="line"><span class="comment">//原文为this.props.firstName 为作者笔误，故改正</span></span><br><span class="line">  &lt;div&gt;&#123;props.firstName&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">Person.defaultProps = &#123;</span></span><br><span class="line"><span class="regexp">  firstName: "Guest"</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>如果一个组件通过条件判断来决定渲染与否，那么可以将存在性检验写在其私有的组件语句中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// best</span></span><br><span class="line"><span class="keyword">const</span> TheOwnerComponent = <span class="function"><span class="params">props</span> =&gt;</span></span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &#123;props.person &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">Person</span> &#123;<span class="attr">...props.person</span>&#125; /&gt;</span>&#125;</span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>上述的存在性检验主要用于对象或者数组。<br>组件所需要的props中，嵌套的数据类型使用 PropTypes来进行检测。</p>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<h2 id="根据props来设置state"><a href="#根据props来设置state" class="headerlink" title="根据props来设置state"></a>根据props来设置state</h2><p>根据props设置state，并且给予props明确的含义。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bad</span></span><br><span class="line">getInitialState () &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    items: <span class="keyword">this</span>.props.items</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// good</span></span><br><span class="line">getInitialState () &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    items: <span class="keyword">this</span>.props.initialItems</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>了解更多: <a href="http://facebook.github.io/react/tips/props-in-getInitialState-as-anti-pattern.html" target="_blank" rel="noopener">“Props in getInitialState Is an Anti-Pattern”</a></p>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<hr>
<h2 id="合理命名事件处理函数"><a href="#合理命名事件处理函数" class="headerlink" title="合理命名事件处理函数"></a>合理命名事件处理函数</h2><p>为了让你给事件处理函数起个有意义的名字，先写事件触发的业务逻辑，之后再进行事件命名。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bad</span></span><br><span class="line">punchABadger () &#123; <span class="comment">/*...*/</span> &#125;,</span><br><span class="line"></span><br><span class="line">render () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;this.punchABadger&#125;</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// good</span></span><br><span class="line">handleClick () &#123; <span class="comment">/*...*/</span> &#125;,</span><br><span class="line"></span><br><span class="line">render () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handleClick&#125;</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p>处理函数的命名应该:</p>
<ul>
<li>以<code>handle</code>作为开始</li>
<li>以其对应的事件作为名字的结束 (例如, <code>Click</code>, <code>Change</code>)</li>
<li>使用一般现在时</li>
</ul>
<p>如果你需要一些消除歧义的名称，你可以在<code>handle</code> 和事件名中间增加一些补充信息，<br>比如说你想要区分<code>onChange</code>事件，就可以是：<code>handleNameChange</code>和 <code>handleAgeChange</code>。不过若真如此，你可能需要想一下是不是需要创造一个新的组件。</p>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<h2 id="对event合理命名"><a href="#对event合理命名" class="headerlink" title="对event合理命名"></a>对event合理命名</h2><p>对于所有者自身的事件使用自定义事件来命名。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Owner</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  handleDelete () &#123;</span><br><span class="line">    <span class="comment">// handle Ownee's onDelete event</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Ownee</span> <span class="attr">onDelete</span>=<span class="string">&#123;this.handleDelete&#125;</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">class Ownee extends React.Component &#123;</span></span><br><span class="line"><span class="xml">  render () &#123;</span></span><br><span class="line">    return &lt;div onChange=&#123;this.props.onDelete&#125; /&gt;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Ownee.propTypes = &#123;</span><br><span class="line">  onDelete: React.PropTypes.func.isRequired</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<h2 id="使用propType"><a href="#使用propType" class="headerlink" title="使用propType"></a>使用propType</h2><p>proptype表示组件所期望的数据类型，以及用于产生有意义的警告。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MyValidatedComponent.propTypes = &#123;</span><br><span class="line">  name: React.PropTypes.string</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>如果接受到的<code>name</code>而不是<code>string</code>，<code>MyValidatedComponent</code> 会打出一个警告。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Person</span> <span class="attr">name</span>=<span class="string">1337</span> /&gt;</span></span><br><span class="line">// Warning: Invalid prop `name` of type `number` supplied to `MyValidatedComponent`, expected `string`.</span><br></pre></td></tr></table></figure>
<p>这个组件要求 所传入的<code>props</code>必须有 name 字段。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MyValidatedComponent.propTypes = &#123;</span><br><span class="line">  name: React.PropTypes.string.isRequired</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>组件会对要求字段进行验证。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Person</span> /&gt;</span></span><br><span class="line">// Warning: Required prop `name` was not specified in `Person`</span><br></pre></td></tr></table></figure></p>
<p>了解更多: <a href="http://facebook.github.io/react/docs/reusable-components.html#prop-validation" target="_blank" rel="noopener">Prop Validation</a></p>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<h2 id="使用实体字符"><a href="#使用实体字符" class="headerlink" title="使用实体字符"></a>使用实体字符</h2><p>使用React原生的 <code>String.fromCharCode()</code> 来处理特殊字符。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bad</span></span><br><span class="line">&lt;div&gt;PiCO · Mascot&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ nope</span></span><br><span class="line"><span class="regexp">&lt;div&gt;PiCO &amp;middot; Mascot&lt;/</span>div&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// good</span></span><br><span class="line">&lt;div&gt;&#123;<span class="string">'PiCO '</span> + <span class="built_in">String</span>.fromCharCode(<span class="number">183</span>) + <span class="string">' Mascot'</span>&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ better</span></span><br><span class="line"><span class="regexp">&lt;div&gt;&#123;`PiCO $&#123;String.fromCharCode(183)&#125; Mascot`&#125;&lt;/</span>div&gt;</span><br></pre></td></tr></table></figure>
<p>了解更多: <a href="http://facebook.github.io/react/docs/jsx-gotchas.html#html-entities" target="_blank" rel="noopener">JSX Gotchas</a></p>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<h2 id="表格"><a href="#表格" class="headerlink" title="表格"></a>表格</h2><p>在<code>table</code>标签中要记得使用<code>tbody</code>。</p>
<p>如果你忘记了<code>tbody</code>标签，虽然React不会像浏览器那样觉得你很ZZ然后帮你加一个，但是React会继续渲染JSX即给<code>table</code>里面直接插入<code>tr</code>，最后的结果可能不可控，使你一脸懵逼，所以记得使用 <code>tbody</code>。 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bad</span></span><br><span class="line">render () &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;table&gt;</span><br><span class="line">      &lt;tr&gt;...&lt;<span class="regexp">/tr&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>table&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// good</span></span><br><span class="line">render () &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;table&gt;</span><br><span class="line">      &lt;tbody&gt;</span><br><span class="line">        &lt;tr&gt;...&lt;<span class="regexp">/tr&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>tbody&gt;</span><br><span class="line">    &lt;<span class="regexp">/table&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<h2 id="classNames库"><a href="#classNames库" class="headerlink" title="classNames库"></a>classNames库</h2><p>使用 <a href="https://www.npmjs.com/package/classnames" target="_blank" rel="noopener">classNames</a>这个库来做类名判断与管理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bad</span></span><br><span class="line">get classes () &#123;</span><br><span class="line">  <span class="keyword">let</span> classes = [<span class="string">'MyComponent'</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.state.active) &#123;</span><br><span class="line">    classes.push(<span class="string">'MyComponent--active'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> classes.join(<span class="string">' '</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">render () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;this.classes&#125;</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// good</span></span><br><span class="line">render () &#123;</span><br><span class="line">  <span class="keyword">let</span> classes = &#123;</span><br><span class="line">    <span class="string">'MyComponent'</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">'MyComponent--active'</span>: <span class="keyword">this</span>.state.active</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;classnames(classes)&#125;</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p>了解更多: <a href="https://github.com/JedWatson/classnames/blob/master/README.md" target="_blank" rel="noopener">Class Name Manipulation</a></p>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<h2 id="JSX"><a href="#JSX" class="headerlink" title="JSX"></a>JSX</h2><p>我在的项目组中曾经有一些 CoffeeScript的拥趸，不幸的事情是在写CoffeeScript数据模板的时候，因为JSX进行了抽象导致模板钩子的实现改变了。</p>
<p>所以我们不推荐使用CoffeeScript来编写render方法。</p>
<p>当必须使用CoffeeScript时，你可以看一下我们怎么使用CoffeeScript： <a href="https://slack-files.com/T024L9M0Y-F02HP4JM3-80d714" target="_blank" rel="noopener">CoffeeScript and JSX</a>.</p>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<h2 id="ES2015"><a href="#ES2015" class="headerlink" title="ES2015"></a>ES2015</h2><p><a href="https://github.com/reactjs/react-rails" target="_blank" rel="noopener">react-rails</a>现在已经集成了<a href="https://babeljs.io" target="_blank" rel="noopener">babel</a>，所有babel能做的事情，在Rails中也可以，你可以参阅文档来了解其相关配置。</p>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<h2 id="react-rails"><a href="#react-rails" class="headerlink" title="react-rails"></a>react-rails</h2><p><a href="https://github.com/reactjs/react-rails" target="_blank" rel="noopener">react-rails</a>可以用于所有使用React开发的Rails Apps。它使得Rails与React之间可以完美结合。</p>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<h2 id="rails-assets"><a href="#rails-assets" class="headerlink" title="rails-assets"></a>rails-assets</h2><p><a href="https://rails-assets.org" target="_blank" rel="noopener">rails-assets</a>是一个资源管理框架，用于管理项目中的js/css等静态资源。我这里最流行的React库是<a href="http://bower.io" target="_blank" rel="noopener">Bower</a>它其可以非常方便的添加依赖与react资源</p>
<p><strong>警告：rails-assets 需要 Sprockets来进行 bower项目的访问。这是rails使用js传统的方法的胜利，这种方法不需要借助js模块化管理工具。</strong></p>
<p><strong><a href="#目录">↑ 返回</a></strong></p>
<h2 id="flux"><a href="#flux" class="headerlink" title="flux"></a>flux</h2><p>使用<a href="http://alt.js.org" target="_blank" rel="noopener">Alt</a>来进行flux开发。flux 文档提到建议配合Alt开发。</p>
<p><strong><a href="#目录">↑ 返回</a></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tuqiang.website/2016/12/11/调教磨人的小妖精 —— canvas.context.save()；sa-res的最佳实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yuri">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="住何乡">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/11/调教磨人的小妖精 —— canvas.context.save()；sa-res的最佳实践/" itemprop="url">调教磨人的小妖精 —— canvas.context.save()；sa/res的最佳实践</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-11T00:00:00+08:00">
                2016-12-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我们在日常借（kao）鉴（bei）别人的代码的时候往往会看到 context.save() || restore()。<br>然后我们看文档就知道了，这是保存当前画布的状态…..个P啊！！！</p>
<p><img src="http://odf9m3avc.bkt.clouddn.com/%E6%B5%B7%E6%9C%AA-%E8%BF%99%E4%B8%AA%E4%BA%BA%E6%98%AF%E4%B8%8D%E6%98%AF%E5%82%BB%E4%BA%86.jpg" alt="此处输入图片的描述"></p>
<hr>
<p>保存了什么？<br>为什么要保存这些？<br>为什么要使用？<br>何如判断是否需要使用？<br>最佳实践是什么？</p>
<p>完全啥没有好么！！！！</p>
<p>定义大家都懂，但是还是过不好一生啊！！！</p>
<p>然而实际上， save（） restore（）这一对磨人的小妖精在实际开发中非常重要，所以我们就来，好好和她们进行一下深入的<del>交流</del>学习。</p>
<h2 id="save（）是-将当前状态放入栈中，保存-canvas-全部状态的方法。"><a href="#save（）是-将当前状态放入栈中，保存-canvas-全部状态的方法。" class="headerlink" title="save（）是 将当前状态放入栈中，保存 canvas 全部状态的方法。"></a><strong>save（）是 将当前状态放入栈中，保存 canvas 全部状态的方法。</strong></h2><h3 id="一、那么首先-：canvas状态-是什么？"><a href="#一、那么首先-：canvas状态-是什么？" class="headerlink" title="一、那么首先 ：canvas状态 是什么？"></a>一、那么首先 ：<strong>canvas状态</strong> 是什么？</h3><p>他不是保存canvas画布上画了什么，而是 用一个栈 将  那些你需要在<code>接下来使用</code>(一、3解释)的<code>工具或属性</code>的状态的当前状态定义并保存。</p>
<h3 id="一、1-保存了哪些工具"><a href="#一、1-保存了哪些工具" class="headerlink" title="一、1 保存了哪些工具"></a>一、1 保存了哪些工具</h3><p>1.确立的<code>变换 矩阵</code> (<strong>敲黑板</strong> 比如 translate、rotate、scale)<br>2.建立的裁剪区域<br>3.创建的虚线列表</p>
<h3 id="一、2-保存了哪些属性"><a href="#一、2-保存了哪些属性" class="headerlink" title="一、2 保存了哪些属性"></a>一、2 保存了哪些属性</h3><p>常用的有  strokeStyle、 fillStyle、globalAlpha、lineWidth、shadowOffsetX、shadowOffsetY、 shadowBlur,、shadowColor、 font、 textAlign。 </p>
<h3 id="一、3-为什么用-为什么保存"><a href="#一、3-为什么用-为什么保存" class="headerlink" title="一、3 为什么用 为什么保存"></a>一、3 为什么用 为什么保存</h3><p>上述状态其实是在动画中经常改变的变量，如果每次都要重新赋值…那得多长的代码量啊。。。</p>
<p>所以<br>接下来<br>如果你需要在你之后的动画中 改变上述的 状态，那么你就需要进行save，除非你要丢弃这些变量曾经的值。</p>
<p>这里我们看个🌰<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Clock</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">        <span class="keyword">this</span>.c = props;</span><br><span class="line">        <span class="keyword">this</span>.x = <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">this</span>.y = <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">this</span>.width = <span class="number">30</span>;</span><br><span class="line">        <span class="keyword">this</span>.height = <span class="number">20</span>;</span><br><span class="line">        <span class="keyword">this</span>.degrees = <span class="number">45</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    init()&#123;</span><br><span class="line">        <span class="comment">// c === canvas.context</span></span><br><span class="line">        <span class="keyword">const</span> c = <span class="keyword">this</span>.c;</span><br><span class="line">        c.fillStyle = <span class="string">"reb(80,80,120)"</span>;</span><br><span class="line">        c.strokeStyle = <span class="string">"red"</span>;</span><br><span class="line">        <span class="comment">//两次画矩形参数完全一样</span></span><br><span class="line">        c.fillRect(<span class="keyword">this</span>.x,<span class="keyword">this</span>.y,<span class="keyword">this</span>.width,<span class="keyword">this</span>.height);</span><br><span class="line"></span><br><span class="line">        c.save();</span><br><span class="line"></span><br><span class="line">        c.rotate(<span class="keyword">this</span>.degrees * <span class="built_in">Math</span>.PI / <span class="number">180</span>);</span><br><span class="line">        c.scale(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        c.translate(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// c.restore();</span></span><br><span class="line">        c.fillStyle = <span class="string">"gold"</span>;</span><br><span class="line">        <span class="comment">//两次画矩形参数完全一样</span></span><br><span class="line">        c.fillRect(<span class="keyword">this</span>.x,<span class="keyword">this</span>.y,<span class="keyword">this</span>.width,<span class="keyword">this</span>.height);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在restore被注释的情况下</p>
<blockquote>
<p>嗯…意识流画风，将就看</p>
</blockquote>
<p><img src="http://odf9m3avc.bkt.clouddn.com/test-re-title.png" alt="此处输入图片的描述"></p>
<p>在restore生效的情况下<br><img src="http://odf9m3avc.bkt.clouddn.com/test-no-re.png" alt="此处输入图片的描述"></p>
<p>因为之前save中已经保存了transformations相关信息（rotate、scale等），经过restore，相关数据被推出栈，<code>覆盖</code>原有数据，金色矩形按照正常坐标轴输出，直接甩在黑矩形脸上。</p>
<p>所以，你可以用任意多次save，但是restore次数要比save少。</p>
<h2 id="二、最佳实践"><a href="#二、最佳实践" class="headerlink" title="二、最佳实践"></a>二、最佳实践</h2><p>前面我们提到，save最明显的作用是减少代码量，这么单调的API能活到现在，一定有其他的作用。</p>
<h2 id="小妖精的技能："><a href="#小妖精的技能：" class="headerlink" title="小妖精的技能："></a>小妖精的技能：</h2><h3 id="1-方便的进行初始化-时间回朔-The-World！！"><a href="#1-方便的进行初始化-时间回朔-The-World！！" class="headerlink" title="1.方便的进行初始化 时间回朔 The World！！"></a>1.方便的进行初始化 <del>时间回朔 The World！！</del></h3><p>假定在栈中，你只有一次的状态改变，那么你就可以，在最开始定义初始态的时候进行一次save（），使用restore来重置状态，非常方便。</p>
<h3 id="2-默认属性的多次使用-咲夜の世界！！"><a href="#2-默认属性的多次使用-咲夜の世界！！" class="headerlink" title="2.默认属性的多次使用 咲夜の世界！！"></a>2.默认属性的多次使用 <del>咲夜の世界！！</del></h3><p>比如有的时候我们会有一套 默认 状态需要被重复利用。</p>
<p>例如我们要画很多个星星什么的，它有很多细节，我们将一套默认状态保存，以免我们重复的设置 set/get function，角度、旋转、字体等等。因为也许你的每一帧这些属性都在改变。</p>
<blockquote>
<p>不是像我们的例子那么简单，这点非常常用</p>
</blockquote>
<p>在很多项目中，如果我们看的深一点，我们就可以发现，别人经常会设置默认值，我看过的不少代码都喜欢这么做</p>
<p>在每一次的 step（你可以理解成一次执行动画或一帧）中， 确定相对新的坐标系，将新到达的绝对坐标点（相对于屏幕），设定为相对初始坐标点，之后使用相对的移动，到达实际绝对定位的坐标。</p>
<p>因为每一次的transformat都是相对之前坐标的。</p>
<p>这…有什么用？ 往下看。<br><img src="http://odf9m3avc.bkt.clouddn.com/%E5%8D%81%E5%85%AD%E5%A4%9C%E5%92%B2%E5%A4%9C.png" alt="此处输入图片的描述"></p>
<h3 id="3-简化计算-光速「C．リコシェ」"><a href="#3-简化计算-光速「C．リコシェ」" class="headerlink" title="3.简化计算 光速「Ｃ．リコシェ」"></a>3.简化计算 <del>光速「Ｃ．リコシェ」</del></h3><blockquote>
<p>毕竟，在你画图的时候，你也许就不知道x、y值</p>
</blockquote>
<p>说~<br>我们要加一张图在h屏幕中间，我们一般会这么写</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.drawImage(myImg, x, y, myImg.width, myImg.height);</span><br></pre></td></tr></table></figure>
<p>当然你可以这么搞，没人阻止你…</p>
<p>可事实上，往往需要计算相对于 画布的“相机”的真实的x、y值，好吧，那我们就在timer里面算吧。。</p>
<p>如果你画的是一个人呢？有帽子，有手的位置，裙子的摆动，等等，你要将这些东西与本体人物割裂开做绝对坐标计算？</p>
<p>当然第一反应是，人物坐标body.x 那么手的坐标就是 body.x - hand.x 或者 + sin（x）….等等等等</p>
<p>嗯…如果你能搞出来 挺厉害的…草稿写一本子了吧，当年的高数是满分吧？</p>
<hr>
<p>所以！！这种情况我们果断采用使用相对默认坐标，改变坐标轴，进行矢量计算就好了。</p>
<p>比如手相对人物坐标长6个px，与人物夹角20°，那就直接旋转20°坐标轴画6个px，不比计算一大堆三角函数好搞得多？绘制完成restore回默认坐标点，继续下一个。</p>
<hr>
<p>所以，save/restore是相当常用也好用的API，好好利用会给我们带来很多的便利，以上的一些最佳实践只是抛砖引玉，欢迎探讨~</p>
<p>参考：</p>
<ol>
<li><a href="http://stackoverflow.com/questions/16409105/whats-the-purpose-of-canvas-context-save-and-restore-in-this-example" target="_blank" rel="noopener">http://stackoverflow.com/questions/16409105/whats-the-purpose-of-canvas-context-save-and-restore-in-this-example</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/save" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/save</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://tuqiang.website/2016/10/25/简析动画执行函数requestAnimationFrame/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yuri">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="住何乡">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/25/简析动画执行函数requestAnimationFrame/" itemprop="url">简析动画执行函数requestAnimationFrame</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-25T00:00:00+08:00">
                2016-10-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我们今天讨论一下：</p>
<p>1.为什么用requestAnimationFrame<br>2.requestAnimationFrame的 作用机制——为什么会更流畅</p>
<p>我们先说 为什么用requestAnimationFrame<br>为什么？主要是为了解决timer导致以下的两个问题 1.跳帧 2.性能</p>
<h1 id="一、跳帧问题"><a href="#一、跳帧问题" class="headerlink" title="一、跳帧问题"></a>一、跳帧问题</h1><p>帧数在一定程度上能决定画面的流畅，一般动画剪辑等24帧25帧30帧就足够，电视30帧，人眼因为视觉暂留对动画的判定最低帧数也就是12帧。而我们平时玩的游戏，一般会固定帧速率（framerate）为60帧。</p>
<h2 id="1-setTimeout-setInterval"><a href="#1-setTimeout-setInterval" class="headerlink" title="1.setTimeout/setInterval"></a>1.setTimeout/setInterval</h2><p><code>timer有两方面的漏洞1.API本身的缺陷 2.浏览器执行的缺陷</code></p>
<h3 id="1-API本身达不到毫秒级的精确"><a href="#1-API本身达不到毫秒级的精确" class="headerlink" title="1.API本身达不到毫秒级的精确"></a>1.API本身达不到毫秒级的精确</h3><p>如果使用 setTimeout或者setInterval 那么需要我们制定时间 假设给予 （1000/60）理论上就可以完成60帧速率的动画。实际上我们做个小demo也能跑。</p>
<p>但是这是很一厢情愿的想法，在HTML5规范中，浏览器为了节省电力消耗可以拉长执行代码的间隔时间<a href="https://www.w3.org/html/ig/zh/wiki/HTML5/timers" target="_blank" rel="noopener">该API不保证计时器将在时间表上精确运行</a>.<br>所以事实是浏览器可以“强制规定时间间隔的下限（clamping th timeout interval）”,一般浏览器所允许的时间再5-10毫秒，也就是说即使你给了某个小于10的数，可能也要等待10毫秒。</p>
<h3 id="2-浏览器不能完美执行"><a href="#2-浏览器不能完美执行" class="headerlink" title="2.浏览器不能完美执行"></a>2.浏览器不能完美执行</h3><p>我们的显示屏一般是16.7ms（即60FPS）的显示频率，我们看图片的第一行，每次刷新间隔就是黑色箭头的中间。<br><img src="https://i-msdn.sec.s-msft.com/dynimg/IC550966.png" alt="突然插入的帧"></p>
<p>如果我们突然给了一个10ms的setTimeout，等于在每次刷新间隔中强制插入了一次渲染，超出本身的正常的绘制流程，这种过度绘制的情况会导致动画断续显示，因为会导致部分的第三帧会丢失。（当然显卡超频是另一码事，我们不谈）<br>打个比方，收银一分钟结两个人，你突然要插队进入，别人就要把你扔出来。<br>虽然浏览器厂家对timer做了很多优化，使其丢帧不会太严重，但是还是存在。简单的动画丢帧倒是也无妨，但是如果是复杂动画或者游戏丢帧就是很严重的事了。</p>
<h2 id="requestAnimationFrame"><a href="#requestAnimationFrame" class="headerlink" title="requestAnimationFrame"></a>requestAnimationFrame</h2><p>我们都知道个人的发展不仅要看自身的努力也要看历史的进程，而request就是按照浏览器的渲染进行走的。</p>
<p>request不像timer这么粗暴的插入，而是根据浏览器的绘制进行，更多的像是一种同化。<br>request 会把每一帧中的所有DOM操作集中起来，在一次重绘或回流中就完成（这点很像虚拟DOM不是~），并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率，它该是10ms咱们也10ms绘制，该是16.7咱们也16.7。跟随浏览器的绘制进行。</p>
<p>这样以来，就保证了不会出现过度渲染的问题，保证了流畅的需求以及浏览器的完美渲染。</p>
<p>二性能<br>性能上的影响有两点，一方面是对当前浏览器的影响，一个是对整个计算机内存的影响。</p>
<h2 id="timer"><a href="#timer" class="headerlink" title="timer"></a>timer</h2><p>timer的渲染机制<a href="https://msdn.microsoft.com/library/hh920765%28v=vs.85%29.aspx" target="_blank" rel="noopener">导致了动画过度绘制，浪费 CPU 周期以及消耗额外的电能等问题。</a>，<br>而且，即使看不到网站，特别是当网站使用背景选项卡中的页面或浏览器已最小化时，动画都会频繁出现。<br>也就是说，你哪怕最小化了页面，切换到了别的页面，耗费着高资源的动画依然在执行。</p>
<p>这种计时器分辨率的降低也会对电池使用寿命造成负面影响，并会降低其他应用的性能。</p>
<h2 id="request"><a href="#request" class="headerlink" title="request"></a>request</h2><p>而request完全没有以上所述方面的性能支出<a href="https://segmentfault.com/a/1190000000386368" target="_blank" rel="noopener">《setInterval与requestAnimationFrame的时间间隔测试》</a>这篇文章很好的佐证了request的高性能。而其本身的避免了过度渲染也规避了cpu的支出。</p>
<hr>
<p>参考：<br><a href="https://hacks.mozilla.org/2011/08/animating-with-javascript-from-setinterval-to-requestanimationframe/" target="_blank" rel="noopener">Animating with javascript: from setInterval to requestAnimationFrame</a><br><a href="http://www.zhangxinxu.com/wordpress/2013/09/css3-animation-requestanimationframe-tween-%E5%8A%A8%E7%94%BB%E7%AE%97%E6%B3%95/" target="_blank" rel="noopener">CSS3动画那么强，requestAnimationFrame还有毛线用？</a><br><a href="https://segmentfault.com/a/1190000000386368" target="_blank" rel="noopener">setInterval与requestAnimationFrame的时间间隔测试</a><br><a href="http://creativejs.com/resources/requestanimationframe/" target="_blank" rel="noopener">requestAnimationFrame The secret to silky smooth JavaScript animation!</a><br><a href="http://jinlong.github.io/2013/06/24/better-performance-with-requestanimationframe/" target="_blank" rel="noopener">requestAnimationFrame 性能更好</a><br><a href="https://msdn.microsoft.com/library/hh920765%28v=vs.85%29.aspx" target="_blank" rel="noopener">基于脚本的动画的计时控制（“requestAnimationFrame”）</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="Yuri" />
            
              <p class="site-author-name" itemprop="name">Yuri</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Yuritu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:tuqiang_ru@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yuri</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a></div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    







  





  

  

  

  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
  </script>

  

  

  

  

</body>
</html>
